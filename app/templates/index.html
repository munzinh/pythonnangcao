{# Trang index, kế thừa từ base.html, trình bày giao diện todo #}
{% extends "base.html" %}

{% block title %}TaskMaster - Todo List Manager{% endblock %}

{% block content %}
<!-- Thanh tiêu đề dịch vụ, group button xuất file & tạo mới task -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i class="bi bi-list-task me-2"></i>My Tasks
            </h1>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="exportTasks('csv')">
                    <i class="bi bi-download me-1"></i>Export CSV
                </button>
                <button class="btn btn-outline-success me-2" onclick="exportTasks('json')">
                    <i class="bi bi-download me-1"></i>Export JSON
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal">
                    <i class="bi bi-plus me-1"></i>Add Task
                </button>
            </div>
        </div>

        <!-- Search & filter nhanh danh sách -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search tasks...">
                    <button class="btn btn-outline-secondary" type="button" onclick="searchTasks()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="filter" id="filterAll" value="all" checked>
                    <label class="btn btn-outline-primary" for="filterAll">All</label>
                    <input type="radio" class="btn-check" name="filter" id="filterPending" value="false">
                    <label class="btn btn-outline-warning" for="filterPending">Pending</label>
                    <input type="radio" class="btn-check" name="filter" id="filterCompleted" value="true">
                    <label class="btn btn-outline-success" for="filterCompleted">Completed</label>
                </div>
            </div>
        </div>

        <!-- Bảng danh sách task (table) -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">#</th>
                                <th width="25%">Title</th>
                                <th width="35%">Description</th>
                                <th width="10%">Priority</th>
                                <th width="10%">Status</th>
                                <th width="15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <!-- Row loading hoặc no data sẽ tự động thay bởi js -->
                            <tr id="loadingRow">
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Thêm/sửa task -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalTitle">Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="taskForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="taskPriority" class="form-label">Priority</label>
                        <select class="form-select" id="taskPriority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div class="mb-3" id="completedField" style="display: none;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="taskCompleted">
                            <label class="form-check-label" for="taskCompleted">
                                Mark as completed
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="taskSubmitBtn">Add Task</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal xác nhận xoá task -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let currentTaskId = null;
    let currentFilter = 'all';
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        loadTasks();
        setupEventListeners();
    });
    
    function setupEventListeners() {
        // Filter change
        document.querySelectorAll('input[name="filter"]').forEach(radio => {
            radio.addEventListener('change', function() {
                currentFilter = this.value;
                loadTasks();
            });
        });
        
        // Search input
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                if (this.value.trim()) {
                    searchTasks();
                } else {
                    loadTasks();
                }
            }, 500);
        });
        
        // Task form submission
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveTask();
        });
        
        // Modal reset
        document.getElementById('taskModal').addEventListener('hidden.bs.modal', function() {
            resetTaskForm();
        });
    }
    
    function loadTasks() {
        const tbody = document.getElementById('tasksTableBody');
        tbody.innerHTML = '<tr id="loadingRow"><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';
        
        let url = '/api/tasks';
        if (currentFilter !== 'all') {
            url += `?completed=${currentFilter}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTasks(data.data);
                } else {
                    showError('Failed to load tasks: ' + data.error);
                }
            })
            .catch(error => {
                showError('Error loading tasks: ' + error.message);
            });
    }
    
    function displayTasks(tasks) {
        const tbody = document.getElementById('tasksTableBody');
        
        if (tasks.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No tasks found</td></tr>';
            return;
        }
        
        tbody.innerHTML = tasks.map(task => `
            <tr>
                <td>${task.id}</td>
                <td>
                    <strong>${escapeHtml(task.title)}</strong>
                </td>
                <td>${escapeHtml(task.description || '')}</td>
                <td>
                    <span class="badge bg-${getPriorityColor(task.priority)}">${task.priority}</span>
                </td>
                <td>
                    <span class="badge bg-${task.completed ? 'success' : 'warning'}">
                        ${task.completed ? 'Completed' : 'Pending'}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editTask(${task.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-${task.completed ? 'warning' : 'success'}" 
                                onclick="toggleTask(${task.id}, ${!task.completed})" 
                                title="${task.completed ? 'Mark as Pending' : 'Mark as Completed'}">
                            <i class="bi bi-${task.completed ? 'arrow-counterclockwise' : 'check'}"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTask(${task.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    function searchTasks() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            loadTasks();
            return;
        }
        
        const tbody = document.getElementById('tasksTableBody');
        tbody.innerHTML = '<tr id="loadingRow"><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';
        
        fetch(`/api/tasks/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTasks(data.data);
                } else {
                    showError('Search failed: ' + data.error);
                }
            })
            .catch(error => {
                showError('Search error: ' + error.message);
            });
    }
    
    function editTask(taskId) {
        currentTaskId = taskId;
        
        fetch(`/api/tasks/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const task = data.data;
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskCompleted').checked = task.completed;
                    
                    document.getElementById('taskModalTitle').textContent = 'Edit Task';
                    document.getElementById('taskSubmitBtn').textContent = 'Update Task';
                    document.getElementById('completedField').style.display = 'block';
                    
                    new bootstrap.Modal(document.getElementById('taskModal')).show();
                } else {
                    showError('Failed to load task: ' + data.error);
                }
            })
            .catch(error => {
                showError('Error loading task: ' + error.message);
            });
    }
    
    function saveTask() {
        const title = document.getElementById('taskTitle').value.trim();
        const description = document.getElementById('taskDescription').value.trim();
        const priority = document.getElementById('taskPriority').value;
        const completed = document.getElementById('taskCompleted').checked;
        
        if (!title) {
            showError('Title is required');
            return;
        }
        
        const taskData = {
            title: title,
            description: description || null,
            priority: priority,
            completed: completed
        };
        
        const url = currentTaskId ? `/api/tasks/${currentTaskId}` : '/api/tasks';
        const method = currentTaskId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                loadTasks();
                showSuccess(data.message);
            } else {
                showError('Failed to save task: ' + data.error);
            }
        })
        .catch(error => {
            showError('Error saving task: ' + error.message);
        });
    }
    
    function toggleTask(taskId, completed) {
        fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ completed: completed })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTasks();
                showSuccess('Task updated successfully');
            } else {
                showError('Failed to update task: ' + data.error);
            }
        })
        .catch(error => {
            showError('Error updating task: ' + error.message);
        });
    }
    
    function deleteTask(taskId) {
        currentTaskId = taskId;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        fetch(`/api/tasks/${currentTaskId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                loadTasks();
                showSuccess('Task deleted successfully');
            } else {
                showError('Failed to delete task: ' + data.error);
            }
        })
        .catch(error => {
            showError('Error deleting task: ' + error.message);
        });
    });
    
    function exportTasks(format) {
        window.open(`/api/tasks/export/${format}`, '_blank');
    }
    
    function resetTaskForm() {
        document.getElementById('taskForm').reset();
        document.getElementById('taskModalTitle').textContent = 'Add New Task';
        document.getElementById('taskSubmitBtn').textContent = 'Add Task';
        document.getElementById('completedField').style.display = 'none';
        currentTaskId = null;
    }
    
    function getPriorityColor(priority) {
        switch (priority) {
            case 'High': return 'danger';
            case 'Medium': return 'warning';
            case 'Low': return 'success';
            default: return 'secondary';
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showSuccess(message) {
        // You can implement a toast notification here
        console.log('Success:', message);
    }
    
    function showError(message) {
        // You can implement a toast notification here
        console.error('Error:', message);
        alert(message); // Temporary fallback
    }
</script>
{% endblock %}
